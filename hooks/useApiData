'use client'
import { useState, useEffect, useCallback } from 'react'
import apiService from '../utils/apiService'
import { API_CONFIG } from '../utils/apiConfig'

export const useApiData = () => {
  const [mapPoints, setMapPoints] = useState([])
  const [buildingControlData, setBuildingControlData] = useState([])
  const [riskZoneData, setRiskZoneData] = useState([])
  const [zoningPlanData, setZoningPlanData] = useState([])
  const [uploadsData, setUploadsData] = useState([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState(null)
  const [metadata, setMetadata] = useState({})

  // Simple API fetch functions (background loading)
  const fetchMapPoints = useCallback(async (params = {}) => {
    try {
      const response = await apiService.getMapPoints(params)
      setMapPoints(response)
      return response
    } catch (err) {
      console.error('Error fetching map points:', err)
      return []
    }
  }, [])

  const fetchBuildingControl = useCallback(async (params = {}) => {
    try {
      const response = await apiService.getBuildingControl(params)
      setBuildingControlData(response)
      return response
    } catch (err) {
      console.error('Error fetching building control:', err)
      return []
    }
  }, [])

  const fetchRiskZone = useCallback(async (params = {}) => {
    try {
      const response = await apiService.getRiskZone(params)
      setRiskZoneData(response)
      return response
    } catch (err) {
      console.error('Error fetching risk zone:', err)
      return []
    }
  }, [])

  const fetchZoningPlan = useCallback(async (params = {}) => {
    try {
      const response = await apiService.getZoningPlan(params)
      setZoningPlanData(response)
      return response
    } catch (err) {
      console.error('Error fetching zoning plan:', err)
      return []
    }
  }, [])

  const fetchUploads = useCallback(async (params = {}) => {
    try {
      const response = await apiService.getUploads(params)
      setUploadsData(response)
      return response
    } catch (err) {
      console.error('Error fetching uploads:', err)
      return []
    }
  }, [])

  // Get processed data for tabs - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ mockup
  const getProcessedData = useCallback((tabType) => {
    console.log('üîÑ getProcessedData called for tab:', tabType)
    
    // Mockup data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ tab
    const mockBuildingControl = [
      {
        id: 'BC-demo-1',
        title: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏• - ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á',
        img: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=400&h=300&fit=crop&crop=center',
        desc: '‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà BC-001/2567 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ô‡∏Ñ‡∏£‡∏ï‡∏£‡∏±‡∏á',
        status: 'approved',
        statusText: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',
        applicant: '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ID: 001',
        location: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï: BC-001/2567',
        submittedDate: '2024-01-15',
        approvedDate: '2024-02-01',
        tags: ['‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', '‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á', '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß'],
        originalData: null
      },
      {
        id: 'BC-demo-2',
        title: '‡∏´‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏• - ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á',
        img: 'https://images.unsplash.com/photo-1545454675-3531b543be5d?w=400&h=300&fit=crop&crop=center',
        desc: '‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà BC-002/2567 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏´‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•',
        status: 'pending',
        statusText: '‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤',
        applicant: '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ID: 002',
        location: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï: BC-002/2567',
        submittedDate: '2024-01-20',
        approvedDate: null,
        tags: ['‡∏´‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á', '‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤'],
        originalData: null
      },
      {
        id: 'BC-demo-3',
        title: '‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡∏ï‡∏£‡∏±‡∏á‡πÅ‡∏Å‡∏£‡∏ô‡∏î‡πå - ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏£‡∏∑‡πâ‡∏≠‡∏ñ‡∏≠‡∏ô',
        img: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=400&h=300&fit=crop&crop=center',
        desc: '‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà BC-003/2567 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∑‡πâ‡∏≠‡∏ñ‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡∏ï‡∏£‡∏±‡∏á‡πÅ‡∏Å‡∏£‡∏ô‡∏î‡πå',
        status: 'draft',
        statusText: '‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£',
        applicant: '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ID: 003',
        location: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï: BC-003/2567',
        submittedDate: null,
        approvedDate: null,
        tags: ['‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°', '‡∏£‡∏∑‡πâ‡∏≠‡∏ñ‡∏≠‡∏ô', '‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'],
        originalData: null
      }
    ]

    const mockRiskZone = [
      {
        id: 'RZ-demo-1',
        title: '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏ô‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏£‡∏±‡∏á',
        img: 'https://images.unsplash.com/photo-1545454675-3531b543be5d?w=400&h=300&fit=crop&crop=center',
        desc: '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏£‡∏±‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏µ‡πà 1',
        status: 'in-progress',
        statusText: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
        contractor: '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏£‡∏±‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
        location: '‡∏ñ‡∏ô‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡∏≠‡∏á',
        startDate: '2024-01-01',
        endDate: null,
        budget: '50,000,000',
        progress: 75,
        tags: ['‡∏ñ‡∏ô‡∏ô', '‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'],
        originalData: null
      },
      {
        id: 'RZ-demo-2',
        title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏ä‡∏∏‡∏°‡∏ä‡∏ô',
        img: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=400&h=300&fit=crop&crop=center',
        desc: '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á',
        status: 'completed',
        statusText: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
        contractor: '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ‡∏Å‡∏£‡∏°‡∏ä‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô',
        location: '‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á',
        startDate: '2023-06-01',
        endDate: '2023-12-31',
        budget: '30,000,000',
        progress: 100,
        tags: ['‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥', '‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'],
        originalData: null
      }
    ]

    const mockZoningPlan = [
      {
        id: 'ZP-demo-1',
        title: '‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏£‡∏±‡∏á 2567-2571',
        img: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=400&h=300&fit=crop&crop=center',
        desc: '‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏£‡∏±‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏µ‡πà 2 (2567-2571)',
        status: 'approved',
        statusText: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',
        department: '‡∏Å‡∏≠‡∏á‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á',
        location: '‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ô‡∏Ñ‡∏£‡∏ï‡∏£‡∏±‡∏á',
        startDate: '2024-01-01',
        endDate: '2028-12-31',
        budget: '100,000,000',
        progress: 25,
        tags: ['‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏á‡∏≤‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß'],
        originalData: null
      },
      {
        id: 'ZP-demo-2',
        title: '‡πÅ‡∏ú‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©',
        img: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=400&h=300&fit=crop&crop=center',
        desc: '‡πÅ‡∏ú‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏£‡∏±‡∏á',
        status: 'planning',
        statusText: '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô',
        department: '‡∏Å‡∏≠‡∏á‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á',
        location: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏£‡∏±‡∏á',
        startDate: null,
        endDate: null,
        budget: '200,000,000',
        progress: 10,
        tags: ['‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©', '‡∏á‡∏≤‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô'],
        originalData: null
      }
    ]
    
    switch (tabType) {
      case 'medical':
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ mockup
        if (buildingControlData && buildingControlData.length > 0) {
          console.log('üèóÔ∏è Using real building control data:', buildingControlData.length)
          return buildingControlData.map((item, index) => {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô params ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏á‡πÜ
            const data = item.params || item
            
            if (!data) {
              console.warn(`‚ö†Ô∏è Item ${index + 1} has no data:`, item)
              return null
            }
            
            const { 
              id, 
              buildingType, 
              building_type, 
              usePurpose, 
              use_purpose, 
              licenseNumber, 
              license_number, 
              status, 
              date, 
              ownerId, 
              owner_id 
            } = data
            
            const processedItem = {
              id: `BC-${id || 'unknown'}`,
              title: item.title || `${buildingType || building_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} - ${usePurpose || use_purpose || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`,
              img: uploadsData.find(upload => upload.buildingControlId === id)?.url || 
                   'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=400&h=300&fit=crop&crop=center',
              desc: `‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${licenseNumber || license_number || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${buildingType || building_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`,
              status: status || 'pending',
              statusText: getStatusText(status || 'pending'),
              applicant: `‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ID: ${ownerId || owner_id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`,
              location: `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï: ${licenseNumber || license_number || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`,
              submittedDate: date,
              approvedDate: status === 'approved' ? date : null,
              tags: [buildingType || building_type, usePurpose || use_purpose, getStatusText(status || 'pending')].filter(Boolean),
              originalData: item,
              // Add coordinates for map connection
              coordinates: { lat: 7.5563 + (index * 0.01), lng: 99.6114 + (index * 0.01) }
            }
            
            console.log(`‚úÖ Processed building control item ${index + 1}:`, processedItem.title)
            return processedItem
          }).filter(Boolean)
        } else {
          console.log('üèóÔ∏è Using mockup building control data:', mockBuildingControl.length)
          return mockBuildingControl.map((item, index) => ({
            ...item,
            // Add coordinates for map connection
            coordinates: { lat: 7.5563 + (index * 0.01), lng: 99.6114 + (index * 0.01) }
          }))
        }

      case 'software':
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ mockup
        if (riskZoneData && riskZoneData.length > 0) {
          console.log('üöß Using real risk zone data:', riskZoneData.length)
          return riskZoneData.map((item, index) => {
            const data = item.params || item
            
            if (!data) {
              console.warn(`‚ö†Ô∏è Item ${index + 1} has no data:`, item)
              return null
            }
            
            const { id, zoneType, description, owner, createdAt } = data
            
            const processedItem = {
              id: `RZ-${id || 'unknown'}`,
              title: item.title || zoneType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
              img: uploadsData.find(upload => upload.riskZoneId === id)?.url || 
                   'https://images.unsplash.com/photo-1545454675-3531b543be5d?w=400&h=300&fit=crop&crop=center',
              desc: description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢',
              status: 'in-progress',
              statusText: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
              contractor: `‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ${owner || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`,
              location: zoneType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
              startDate: createdAt,
              endDate: null,
              budget: '0',
              progress: 50,
              tags: [zoneType, '‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'].filter(Boolean),
              originalData: item
            }
            
            console.log(`‚úÖ Processed risk zone item ${index + 1}:`, processedItem.title)
            return processedItem
          }).filter(Boolean)
        } else {
          console.log('üöß Using mockup risk zone data:', mockRiskZone.length)
          return mockRiskZone.map((item, index) => ({
            ...item,
            // Add coordinates for map connection
            coordinates: { lat: 7.5663 + (index * 0.01), lng: 99.6214 + (index * 0.01) }
          }))
        }

      case 'financial':
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ mockup
        if (zoningPlanData && zoningPlanData.length > 0) {
          console.log('üèõÔ∏è Using real zoning plan data:', zoningPlanData.length)
          return zoningPlanData.map((item, index) => {
            const data = item.params || item
            
            if (!data) {
              console.warn(`‚ö†Ô∏è Item ${index + 1} has no data:`, item)
              return null
            }
            
            const { id, areaName, notes, status, createdAt } = data
            
            const processedItem = {
              id: `ZP-${id || 'unknown'}`,
              title: item.title || (areaName || '‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á'),
              img: uploadsData.find(upload => upload.zoningPlanId === id)?.url || 
                   'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=400&h=300&fit=crop&crop=center',
              desc: notes || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢',
              status: status || 'draft',
              statusText: getStatusText(status || 'draft'),
              department: '‡∏Å‡∏≠‡∏á‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á',
              location: areaName || '‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•',
              startDate: createdAt,
              endDate: null,
              budget: '0',
              progress: 25,
              tags: [areaName || '‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏á‡∏≤‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á', getStatusText(status || 'draft')].filter(Boolean),
              originalData: item,
              // Add coordinates for map connection
              coordinates: { lat: 7.5463 + (index * 0.01), lng: 99.6014 + (index * 0.01) }
            }
            
            console.log(`‚úÖ Processed zoning plan item ${index + 1}:`, processedItem.title)
            return processedItem
          }).filter(Boolean)
        } else {
          console.log('üèõÔ∏è Using mockup zoning plan data:', mockZoningPlan.length)
          return mockZoningPlan.map((item, index) => ({
            ...item,
            // Add coordinates for map connection
            coordinates: { lat: 7.5463 + (index * 0.01), lng: 99.6014 + (index * 0.01) }
          }))
        }

      default:
        return []
    }
  }, [buildingControlData, riskZoneData, zoningPlanData, uploadsData])

  // Get status text
  const getStatusText = (status) => {
    switch (status) {
      case 'approved': return '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß'
      case 'pending': return '‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤'
      case 'rejected': return '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
      case 'draft': return '‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'
      case 'completed': return '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'
      case 'in-progress': return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'
      case 'planning': return '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô'
      default: return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
    }
  }

  // Get map markers data
  const getMapMarkers = useCallback(() => {
    console.log('üó∫Ô∏è Getting map markers...')
    
    const mockMarkers = [
      {
        id: 'demo-1',
        type: 'buildingControl',
        name: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•',
        coordinates: { lat: 7.5563, lng: 99.6114 },
        color: '#3B82F6',
        icon: 'üèóÔ∏è',
        popupContent: `<div class="p-3"><h3 class="font-bold">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•</h3><p>‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</p></div>`
      },
      {
        id: 'demo-2',
        type: 'riskZone',
        name: '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏ô‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡∏≠‡∏á',
        coordinates: { lat: 7.5663, lng: 99.6214 },
        color: '#EF4444',
        icon: '‚ö†Ô∏è',
        popupContent: `<div class="p-3"><h3 class="font-bold">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏ô‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡∏≠‡∏á</h3><p>‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</p></div>`
      },
      {
        id: 'demo-3',
        type: 'zoningPlan',
        name: '‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏£‡∏±‡∏á',
        coordinates: { lat: 7.5463, lng: 99.6014 },
        color: '#10B981',
        icon: 'üèõÔ∏è',
        popupContent: `<div class="p-3"><h3 class="font-bold">‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏£‡∏±‡∏á</h3><p>‡∏á‡∏≤‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á</p></div>`
      }
    ]
    
    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ mockup
    if (mapPoints && mapPoints.length > 0) {
      console.log('üó∫Ô∏è Using real map points:', mapPoints.length)
      const validMarkers = mapPoints.map((point, index) => {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô params ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏á‡πÜ
        const data = point.params || point
        
        if (!data) {
          console.warn(`‚ö†Ô∏è Map point ${index + 1} has no data:`, point)
          return null
        }
        
        const { 
          id, 
          name_local, 
          nameLocal, 
          house_no, 
          houseNo, 
          road, 
          subdistrict, 
          district, 
          province, 
          postcode, 
          latitude, 
          longitude 
        } = data
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ coordinates ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!latitude || !longitude) {
          console.warn(`‚ö†Ô∏è Map point ${index + 1} missing coordinates:`, data)
          return null
        }
        
        // Get point type from AdminJS data
        let pointType = null
        if (data.buildingControl || data.buildingControlId) pointType = 'buildingControl'
        else if (data.riskZone || data.riskZoneId) pointType = 'riskZone'
        else if (data.zoningPlan || data.zoningPlanId) pointType = 'zoningPlan'
        
        return {
          id: id || point.id,
          type: pointType,
          name: name_local || nameLocal || point.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',
          coordinates: {
            lat: parseFloat(latitude),
            lng: parseFloat(longitude)
          },
          color: apiService.getPointColor(pointType),
          icon: apiService.getPointIcon(pointType),
          popupContent: `
            <div class="p-3">
              <h3 class="font-bold text-lg mb-2">${name_local || nameLocal || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h3>
              <p class="text-sm text-gray-600 mb-2">
                ${house_no || houseNo || ''} ${road || ''}<br>
                ${subdistrict || ''}, ${district || ''}<br>
                ${province || ''} ${postcode || ''}
              </p>
              <p class="text-xs text-gray-500">
                ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${getPointTypeText(pointType)}<br>
                ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${point.updatedAt ? new Date(point.updatedAt).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
              </p>
            </div>
          `,
          title: point.title,
          recordActions: point.recordActions || [],
          bulkActions: point.bulkActions || []
        }
      }).filter(Boolean)
      
      console.log(`üó∫Ô∏è Processed ${validMarkers.length} valid map markers`)
      return validMarkers.length > 0 ? validMarkers : mockMarkers
    } else {
      console.log('üó∫Ô∏è Using mockup map markers')
      return mockMarkers
    }
  }, [mapPoints])

  // Get map markers from card data for better integration
  const getMapMarkersFromCards = useCallback((tabType) => {
    const cardData = getProcessedData(tabType)
    return cardData.map((item) => ({
      id: item.id,
      type: tabType === 'medical' ? 'buildingControl' : 
            tabType === 'software' ? 'riskZone' : 'zoningPlan',
      name: item.title,
      coordinates: item.coordinates,
      color: tabType === 'medical' ? '#3B82F6' : 
             tabType === 'software' ? '#EF4444' : '#10B981',
      icon: tabType === 'medical' ? 'üèóÔ∏è' : 
            tabType === 'software' ? '‚ö†Ô∏è' : 'üèõÔ∏è',
      popupContent: `
        <div class="p-3">
          <h3 class="font-bold text-lg mb-2">${item.title}</h3>
          <p class="text-sm text-gray-600 mb-2">${item.desc}</p>
          <p class="text-xs text-gray-500">
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${item.statusText}<br>
            ‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠: ${item.applicant || item.contractor || item.department}
          </p>
        </div>
      `,
      title: item.title,
      cardData: item
    }))
  }, [getProcessedData])

  // Get card data with coordinates for map connection
  const getCardDataWithCoordinates = useCallback((tabType) => {
    const cardData = getProcessedData(tabType)
    return cardData.map((item, index) => ({
      ...item,
      // Ensure coordinates exist for map connection
      coordinates: item.coordinates || { 
        lat: 7.5563 + (index * 0.01), 
        lng: 99.6114 + (index * 0.01) 
      }
    }))
  }, [getProcessedData])

  // Get point type text
  const getPointTypeText = (type) => {
    switch (type) {
      case 'buildingControl':
        return '‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á'
      case 'riskZone':
        return '‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞'
      case 'zoningPlan':
        return '‡∏á‡∏≤‡∏ô‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á'
      default:
        return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
    }
  }

  // Background API loading - ‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Ñ UI
  useEffect(() => {
    console.log('üîÑ Starting background API loading...')
    
    // ‡πÇ‡∏´‡∏•‡∏î API ‡πÉ‡∏ô background ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà set loading state
    Promise.allSettled([
      fetchMapPoints(),
      fetchBuildingControl(),
      fetchRiskZone(),
      fetchZoningPlan(),
      fetchUploads()
    ]).then(() => {
      console.log('‚úÖ Background API loading completed')
    }).catch((error) => {
      console.error('‚ùå Background API loading error:', error)
    })
  }, [])

  return {
    // Data
    mapPoints,
    buildingControlData,
    riskZoneData,
    zoningPlanData,
    uploadsData,
    
    // Loading and error states (always false for mockup)
    loading: false,
    error: null,
    metadata,
    
    // Functions
    fetchMapPoints,
    fetchBuildingControl,
    fetchRiskZone,
    fetchZoningPlan,
    fetchUploads,
    getProcessedData,
    getMapMarkers,
    getMapMarkersFromCards,
    
    // Utilities
    getStatusText,
    getPointTypeText,
    getCardDataWithCoordinates
  }
} 